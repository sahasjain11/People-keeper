
import React, { useState, useEffect } from 'react';
import { 
  Plus, Trash2, Users, Save, CheckCircle2, Clock, 
  Search, X, Calendar, Edit2, Check, Download, 
  Moon, Sun, ArrowUpDown 
} from 'lucide-react';

export default function App() {
  // --- STATE MANAGEMENT ---

  // Names Data
  const [names, setNames] = useState(() => {
    try {
      const savedNames = localStorage.getItem('myPeopleList');
      return savedNames ? JSON.parse(savedNames) : [];
    } catch (error) {
      return [];
    }
  });

  // Dark Mode
  const [darkMode, setDarkMode] = useState(() => {
    try {
      return JSON.parse(localStorage.getItem('pk_darkMode')) || false;
    } catch { return false; }
  });

  // Inputs & Filters
  const [inputValue, setInputValue] = useState('');
  const [searchTerm, setSearchTerm] = useState('');
  const [sortOption, setSortOption] = useState('newest'); // newest, oldest, az, za
  const [notification, setNotification] = useState(null);

  // Editing State
  const [editingId, setEditingId] = useState(null);
  const [editValue, setEditValue] = useState('');

  // --- EFFECTS ---

  // Save Names
  useEffect(() => {
    localStorage.setItem('myPeopleList', JSON.stringify(names));
  }, [names]);

  // Save/Apply Dark Mode
  useEffect(() => {
    localStorage.setItem('pk_darkMode', JSON.stringify(darkMode));
  }, [darkMode]);

  // --- ACTIONS ---

  const handleAddName = (e) => {
    e.preventDefault();
    const trimmedName = inputValue.trim();
    if (trimmedName) {
      const newPerson = {
        id: Date.now(),
        text: trimmedName,
        createdAt: new Date().toISOString()
      };
      setNames(prev => [newPerson, ...prev]);
      setInputValue('');
      showNotification('Person added successfully!');
    }
  };

  const handleDelete = (id) => {
    if (window.confirm('Delete this person?')) {
      setNames(prev => prev.filter(name => name.id !== id));
      showNotification('Entry removed.');
    }
  };

  const startEditing = (person) => {
    setEditingId(person.id);
    setEditValue(person.text);
  };

  const saveEdit = () => {
    if (editValue.trim()) {
      setNames(prev => prev.map(p => 
        p.id === editingId ? { ...p, text: editValue.trim() } : p
      ));
      setEditingId(null);
      showNotification('Name updated!');
    }
  };

  const cancelEdit = () => {
    setEditingId(null);
    setEditValue('');
  };

  const handleClearAll = () => {
    if (window.confirm('Are you sure you want to clear the entire list?')) {
      setNames([]);
      showNotification('All entries cleared.');
    }
  };

  const handleExport = () => {
    if (names.length === 0) return;

    // Create CSV content
    const csvContent = "data:text/csv;charset=utf-8," 
      + "Name,Created At\n"
      + names.map(row => `${row.text},${row.createdAt}`).join("\n");

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "people_list.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('List downloaded as CSV');
  };

  const showNotification = (msg) => {
    setNotification(msg);
    setTimeout(() => setNotification(null), 2000);
  };

  // --- HELPERS ---

  const formatDate = (isoString) => {
    const date = new Date(isoString || Date.now());
    return new Intl.DateTimeFormat('en-US', {
      month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
    }).format(date);
  };

  // --- FILTERING & SORTING ---

  const getProcessedNames = () => {
    // 1. Filter
    let processed = names.filter(person => 
      person.text.toLowerCase().includes(searchTerm.toLowerCase())
    );

    // 2. Sort
    processed.sort((a, b) => {
      if (sortOption === 'newest') return new Date(b.createdAt) - new Date(a.createdAt);
      if (sortOption === 'oldest') return new Date(a.createdAt) - new Date(b.createdAt);
      if (sortOption === 'az') return a.text.localeCompare(b.text);
      if (sortOption === 'za') return b.text.localeCompare(a.text);
      return 0;
    });

    return processed;
  };

  const displayedNames = getProcessedNames();

  return (
    <div className={`min-h-screen transition-colors duration-300 font-sans ${darkMode ? 'bg-slate-900 text-slate-100' : 'bg-slate-100 text-slate-900'}`}>
      <div className="max-w-xl mx-auto py-8 px-4 sm:px-6">
        
        {/* Header with Dark Mode Toggle */}
        <div className="flex items-center justify-between mb-8">
          <div className="flex items-center gap-3">
             <div className={`p-2 rounded-xl shadow-lg ${darkMode ? 'bg-indigo-500' : 'bg-indigo-600'}`}>
               <Users className="w-6 h-6 text-white" />
             </div>
             <div>
               <h1 className="text-2xl font-bold tracking-tight">People Keeper</h1>
               <p className={`text-xs ${darkMode ? 'text-slate-400' : 'text-slate-500'}`}>Ultimate Edition</p>
             </div>
          </div>
          <button 
            onClick={() => setDarkMode(!darkMode)}
            className={`p-2 rounded-full transition-colors ${darkMode ? 'bg-slate-800 text-yellow-400 hover:bg-slate-700' : 'bg-white text-slate-600 hover:bg-slate-200 shadow-sm'}`}
            title="Toggle Dark Mode"
          >
            {darkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
          </button>
        </div>

        {/* Controls Container */}
        <div className={`rounded-2xl shadow-xl overflow-hidden mb-6 border transition-colors ${darkMode ? 'bg-slate-800 border-slate-700 shadow-black/20' : 'bg-white border-slate-100 shadow-slate-200/50'}`}>
          <div className="p-5 space-y-5">
            
            {/* Input Form */}
            <form onSubmit={handleAddName}>
              <div className="flex gap-2">
                <input
                  type="text"
                  value={inputValue}
                  onChange={(e) => setInputValue(e.target.value)}
                  placeholder="Add new name..."
                  className={`block w-full rounded-xl border p-3 outline-none transition-all ${darkMode ? 'bg-slate-700 border-slate-600 text-white placeholder:text-slate-400 focus:border-indigo-500' : 'bg-slate-50 border-slate-200 text-slate-900 focus:bg-white focus:border-indigo-500'}`}
                />
                <button
                  type="submit"
                  disabled={!inputValue.trim()}
                  className="inline-flex items-center justify-center rounded-xl bg-indigo-600 px-5 py-3 text-white shadow-md hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all active:scale-95"
                >
                  <Plus className="w-5 h-5" />
                </button>
              </div>
            </form>

            {/* Toolbar: Search & Sort */}
            {names.length > 0 && (
              <div className={`pt-4 border-t flex flex-col sm:flex-row gap-3 ${darkMode ? 'border-slate-700' : 'border-slate-100'}`}>
                {/* Search */}
                <div className="relative flex-1">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Search className={`h-4 w-4 ${darkMode ? 'text-slate-500' : 'text-slate-400'}`} />
                  </div>
                  <input
                    type="text"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    placeholder="Search..."
                    className={`block w-full pl-10 rounded-lg border text-sm p-2.5 outline-none transition-colors ${darkMode ? 'bg-slate-900 border-slate-600 text-white focus:border-indigo-500' : 'bg-slate-50 border-slate-200 text-slate-900 focus:bg-white focus:border-indigo-500'}`}
                  />
                  {searchTerm && (
                    <button 
                      onClick={() => setSearchTerm('')}
                      className="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-indigo-500"
                    >
                      <X className="w-3 h-3" />
                    </button>
                  )}
                </div>

                {/* Sort Dropdown */}
                <div className="relative min-w-[140px]">
                  <div className="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                    <ArrowUpDown className={`h-3 w-3 ${darkMode ? 'text-slate-500' : 'text-slate-400'}`} />
                  </div>
                  <select 
                    value={sortOption}
                    onChange={(e) => setSortOption(e.target.value)}
                    className={`block w-full pl-8 pr-3 rounded-lg border text-sm p-2.5 outline-none appearance-none cursor-pointer transition-colors ${darkMode ? 'bg-slate-900 border-slate-600 text-white focus:border-indigo-500' : 'bg-slate-50 border-slate-200 text-slate-900 focus:bg-white focus:border-indigo-500'}`}
                  >
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="az">Name (A-Z)</option>
                    <option value="za">Name (Z-A)</option>
                  </select>
                </div>
              </div>
            )}
          </div>
        </div>

        {/* Global Actions */}
        {names.length > 0 && (
          <div className="flex items-center justify-between px-1 mb-4">
             <span className={`text-xs font-bold uppercase tracking-wider ${darkMode ? 'text-slate-500' : 'text-slate-400'}`}>
               List ({displayedNames.length})
             </span>
             <div className="flex gap-2">
                <button 
                  onClick={handleExport}
                  className={`flex items-center gap-1 text-xs font-medium px-3 py-1.5 rounded-lg transition-colors ${darkMode ? 'text-indigo-400 hover:bg-slate-800' : 'text-indigo-600 hover:bg-indigo-50'}`}
                >
                  <Download className="w-3 h-3" /> Export
                </button>
                <button 
                  onClick={handleClearAll}
                  className={`text-xs font-medium px-3 py-1.5 rounded-lg transition-colors ${darkMode ? 'text-red-400 hover:bg-slate-800' : 'text-red-500 hover:bg-red-50'}`}
                >
                  Clear All
                </button>
             </div>
          </div>
        )}

        {/* Main List */}
        <div className="space-y-3 pb-20">
          {names.length === 0 ? (
            <div className={`text-center py-16 rounded-2xl border border-dashed ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-300'}`}>
              <div className={`inline-flex items-center justify-center w-12 h-12 rounded-full mb-3 ${darkMode ? 'bg-slate-700' : 'bg-slate-50'}`}>
                <Calendar className={`w-6 h-6 ${darkMode ? 'text-slate-500' : 'text-slate-300'}`} />
              </div>
              <p className={`font-medium ${darkMode ? 'text-slate-400' : 'text-slate-500'}`}>List is empty</p>
            </div>
          ) : displayedNames.length === 0 ? (
             <div className="text-center py-12">
              <p className="text-slate-500">No matches for "{searchTerm}"</p>
            </div>
          ) : (
            <ul className="space-y-3">
              {displayedNames.map((person) => (
                <li 
                  key={person.id}
                  className={`group p-4 rounded-xl shadow-sm border transition-all duration-200 
                    ${editingId === person.id 
                      ? (darkMode ? 'bg-slate-800 border-indigo-500 ring-1 ring-indigo-500' : 'bg-white border-indigo-500 ring-1 ring-indigo-500')
                      : (darkMode ? 'bg-slate-800 border-slate-700 hover:border-slate-600' : 'bg-white border-slate-200/60 hover:border-indigo-300 hover:shadow-md')
                    }
                  `}
                >
                  {editingId === person.id ? (
                    // EDIT MODE
                    <div className="flex items-center gap-2">
                      <input 
                        type="text" 
                        value={editValue} 
                        onChange={(e) => setEditValue(e.target.value)}
                        className={`flex-1 min-w-0 bg-transparent border-b outline-none text-sm py-1 font-medium ${darkMode ? 'text-white border-indigo-500' : 'text-slate-800 border-indigo-500'}`}
                        autoFocus
                      />
                      <button onClick={saveEdit} className="p-1.5 rounded-md bg-green-500 text-white hover:bg-green-600">
                        <Check className="w-4 h-4" />
                      </button>
                      <button onClick={cancelEdit} className="p-1.5 rounded-md bg-slate-500 text-white hover:bg-slate-600">
                        <X className="w-4 h-4" />
                      </button>
                    </div>
                  ) : (
                    // VIEW MODE
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-4 overflow-hidden">
                        <div className="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white flex items-center justify-center text-lg font-bold shadow-sm">
                          {person.text.charAt(0).toUpperCase()}
                        </div>
                        <div className="min-w-0">
                          <p className={`font-semibold truncate pr-4 ${darkMode ? 'text-slate-200' : 'text-slate-800'}`}>
                            {person.text}
                          </p>
                          <div className="flex items-center text-xs text-slate-400 mt-0.5 gap-1">
                            <Clock className="w-3 h-3" />
                            <span>{formatDate(person.createdAt || person.id)}</span>
                          </div>
                        </div>
                      </div>
                      
                      <div className="flex items-center gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                        <button
                          onClick={() => startEditing(person)}
                          className={`p-2 rounded-lg transition-colors ${darkMode ? 'text-slate-400 hover:bg-slate-700 hover:text-indigo-400' : 'text-slate-400 hover:bg-indigo-50 hover:text-indigo-600'}`}
                          title="Edit"
                        >
                          <Edit2 className="w-4 h-4" />
                        </button>
                        <button
                          onClick={() => handleDelete(person.id)}
                          className={`p-2 rounded-lg transition-colors ${darkMode ? 'text-slate-400 hover:bg-slate-700 hover:text-red-400' : 'text-slate-400 hover:bg-red-50 hover:text-red-600'}`}
                          title="Delete"
                        >
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    </div>
                  )}
                </li>
              ))}
            </ul>
          )}
        </div>

        {/* Toast Notification */}
        {notification && (
          <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900/90 backdrop-blur-sm text-white px-5 py-3 rounded-full shadow-2xl flex items-center gap-3 text-sm animate-fade-in-up z-50 font-medium border border-white/10">
            <CheckCircle2 className="w-4 h-4 text-green-400" />
            {notification}
          </div>
        )}
      </div>
    </div>
  );
}


